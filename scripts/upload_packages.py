import boto3
import os
import json
import hashlib
import sys
"""
Uploads a list of package names from a local file to SQS so they can be
processed
"""

MAX_BATCH_SIZE = 10

client = boto3.client('sqs')

response = client.get_queue_url(
    QueueName=os.environ.get('OSSMALWARE_QUEUE_NAME'), )

queue_url = response['QueueUrl']

with open(sys.argv[1], 'r') as packages:
    batch = []
    for package in packages.readlines():
        package = package.strip()
        batch.append({
            'Id':
            hashlib.sha1(package.encode('utf-8')).hexdigest(),
            'MessageBody':
            json.dumps({
                'type': 'pypi',
                'version': '',
                'name': package
            })
        })
        if len(batch) == 10:
            response = client.send_message_batch(QueueUrl=queue_url,
                                                 Entries=batch)
            if len(response.get('Successful')) == len(batch):
                print('[*] Uploaded {} ... {}'.format(batch[0], batch[-1]))
            else:
                for failure in response.get('Failed'):
                    print('[!] Failed to upload {}: {}'.format(
                        failure.get('Id'), failure.get('Message')))
            batch = []
